name: Server Tests

on:
  push:
    branches: [main]
  pull_request:
    paths:
      - 'packages/server/**'
      - 'packages/migrations/**'
      - '.github/workflows/server-tests.yml'

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: accounter_test
        ports:
          - 5432:5432
        # Health check to ensure DB is ready
        options: >-
          --health-cmd "pg_isready -U postgres" --health-interval 10s --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version-file: '.node-version'
          cache: 'yarn'

      - name: Install Dependencies
        run: |
          yarn install --frozen-lockfile

      - name: Wait for Postgres
        run: |
          for i in {1..20}; do
            pg_isready -h 127.0.0.1 -p 5432 -U postgres && exit 0
            echo "Postgres not ready yet..."
            sleep 2
          done
          echo "Postgres failed to start" >&2
          exit 1

      - name: Run Migrations (Up)
        env:
          POSTGRES_HOST: 127.0.0.1
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: accounter_test
          POSTGRES_SSL: '0'
        run: |
          yarn workspace @accounter-helper/migrations migration:run

      - name: Cache GraphQL Generated Types
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        id: graphql-cache
        with:
          path: |
            schema.graphql
            packages/server/src/modules/**/__generated__
            packages/client/src/gql
          key:
            graphql-codegen-${{ runner.os }}-${{ hashFiles('packages/server/src/modules/**/*.ts',
            'codegen.ts', 'graphql.config.js', 'packages/client/src/**/*.{,c,m}{j,t}s{,x}',
            'yarn.lock') }}
          restore-keys: |
            graphql-codegen-${{ runner.os }}-

      - name: Generate GraphQL Types
        if: ${{ steps.graphql-cache.outputs.cache-hit != 'true' }}
        shell: bash
        run: yarn generate:graphql

      - name: Cache PgTyped Generated Types
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        id: pgtyped-cache
        with:
          path: |
            packages/server/src/**/*.types.ts
            packages/migrations/src/**/*.types.ts
          key:
            pgtyped-${{ runner.os }}-${{ hashFiles('docker/pgconfig.json', 'yarn.lock',
            'packages/server/src/**/providers/*.provider.ts',
            'packages/server/src/plugins/admin-context-plugin.ts') }}
          restore-keys: |
            pgtyped-${{ runner.os }}-

      - name: Generate Postgres Types
        if: ${{ steps.pgtyped-cache.outputs.cache-hit != 'true' }}
        env:
          POSTGRES_HOST: 127.0.0.1
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: accounter_test
          POSTGRES_SSL: '0'
        shell: bash
        run: yarn generate:sql

      - name: Run Server Tests (Integration)
        if: github.event_name == 'pull_request'
        env:
          POSTGRES_HOST: 127.0.0.1
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: accounter_test
          POSTGRES_SSL: '0'
          DEFAULT_FINANCIAL_ENTITY_ID: '00000000-0000-0000-0000-000000000000'
          DEBUG: ''
        run: |
          yarn test:integration --reporter=default --coverage
      - name: Run Server Tests (All)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          POSTGRES_HOST: 127.0.0.1
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: accounter_test
          POSTGRES_SSL: '0'
          DEFAULT_FINANCIAL_ENTITY_ID: '00000000-0000-0000-0000-000000000000'
          ALLOW_DEMO_SEED: '1'
          DEBUG: ''
        run: |
          yarn test:all --reporter=default --coverage

      - name: Upload Coverage
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: coverage
          path: coverage

      - name: Fail if Latest Migration Missing
        if: always()
        env:
          POSTGRES_HOST: 127.0.0.1
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: accounter_test
          POSTGRES_SSL: '0'
        run: |
          node --import ./scripts/register-esm.js ./scripts/verify-migrations.ts
