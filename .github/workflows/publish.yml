name: Publish Package

env:
  NODE_NO_WARNINGS: true
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  POSTGRES_HOST: localhost
  POSTGRES_PORT: 5432
  POSTGRES_DB: accounter
  CI: true
  # Standardizing the build environment
  NODE_ENV: production

on:
  workflow_call:
    inputs:
      type:
        description: 'Type of release (snapshot or stable)'
        required: true
        type: string
      ref:
        description: 'Git ref to checkout'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  packages: write
  id-token: write

jobs:
  publish:
    name: Build and Publish to NPM
    if: github.repository == 'Urigo/accounter-fullstack'
    runs-on: ubuntu-latest

    steps:
      - name: checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          ref: ${{ inputs.ref || github.sha }}

      - name: setup environment
        uses: ./.github/actions/setup
        with:
          registryUrl: 'https://registry.npmjs.org'

      - name: Setup NPM Auth
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version-file: .node-version
          registry-url: 'https://registry.npmjs.org'

      - name: Update npm
        run: npm install -g npm@latest

      - name: Setup Yarn Auth
        shell: bash
        run: |
          echo "YARN_NPM_AUTH_TOKEN=$NODE_AUTH_TOKEN" >> $GITHUB_ENV

      - name: Versioning - Calculate Alpha Snapshot
        # This step uses the Changesets CLI to create a temporary version based on a timestamp
        # It updates package.json files locally but does not commit them
        if: ${{ inputs.type == 'snapshot' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          yarn changeset version --snapshot alpha

      - name: Build Packages
        shell: bash
        run: yarn build

      - name: Snapshot Publish - Deploy to NPM
        # Publishes the calculated snapshot to the registry under the 'alpha' tag
        if: ${{ inputs.type == 'snapshot' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_CONFIG_PROVENANCE: 'true'
          # FORCE npm to ignore any potential secret tokens
          NODE_AUTH_TOKEN: ''
          NPM_TOKEN: ''
        run: |
          # Capture output to file while still showing it in logs
          set -o pipefail
          npx changeset publish --tag alpha --no-git-tag --access public 2>&1 | tee publish-output.txt

      - name: Post-Release Notification
        # Providing a feedback loop directly on the Pull Request
        if: ${{ inputs.type == 'snapshot' }}
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            try {
              const output = fs.readFileSync('publish-output.txt', 'utf8');
              const regex = /Publishing "(.*?)" at "(.*?)"/g;
              let match;
              let items = [];
              
              while ((match = regex.exec(output)) !== null) {
                items.push({ package: match[1], version: match[2] });
              }
              
              if (items.length > 0) {
                 let message = '### ðŸ¦‹ Snapshot Release\n\nThe following packages have been published to NPM:\n\n| Package | Version |\n|---|---|\n';
                 items.forEach(item => {
                   message += `| \`${item.package}\` | \`${item.version}\` |\n`;
                 });
                 message += '\n\nYou can install the snapshot version by running:\n```bash\nnpm install package-name@version\n```';

                 // Attempt to find the PR number
                 let prNumber = context.payload.pull_request ? context.payload.pull_request.number : undefined;
                 if (!prNumber && context.payload.issue && context.payload.issue.number) {
                    prNumber = context.payload.issue.number;
                 }
                 
                 if (prNumber) {
                   await github.rest.issues.createComment({
                      issue_number: prNumber,
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      body: message
                   });
                 } else {
                   console.log('No PR number found in context, skipping comment.');
                   console.log(message);
                 }
              }
            } catch (e) {
              console.log('Error processing publish output for comment:', e);
            }

      - name: Set release date
        if: ${{ inputs.type == 'stable' }}
        id: vars
        shell: bash
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: release / pull_request
        if: ${{ inputs.type == 'stable' }}
        id: changesets-stable
        uses: dotansimha/changesets-action@069996e9be15531bd598272996fa23853d61590e # v1.5.2
        with:
          publish: 'npx changeset publish'
          version: 'yarn changeset version'
          commit: 'chore(release): update monorepo packages versions'
          title: 'Upcoming Release Changes'
          createGithubReleases: aggregate
          githubReleaseName: ${{ steps.vars.outputs.date }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
